
<!DOCTYPE html>
<html>
<head>
  <!--
    Kilsbergen MkDocs theme copyright 2019 Ruud van Asseldonk.
    Licensed under the Apache 2.0 license.
    See https://github.com/ruuda/kilsbergen.
  -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Disks — Musium</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,400i" rel="stylesheet">
  <style>
  /* The Inter font family, see https://rsms.me/inter.
     https://rsms.me/inter/#faq-cdn suggests that linking these files directly is fine.
  */
  @font-face {
    font-family: Inter;
    font-style:  normal;
    font-weight: 400;
    src: url("https://rsms.me/inter/font-files/Inter-Regular.woff2?v=3.11") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-Regular.woff?v=3.11") format("woff");
  }
  @font-face {
    font-family: Inter;
    font-style:  italic;
    font-weight: 400;
    src: url("https://rsms.me/inter/font-files/Inter-Italic.woff2?v=3.11") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-Italic.woff?v=3.11") format("woff");
  }
  @font-face {
    font-family: Inter;
    font-style:  normal;
    font-weight: 500;
    src: url("https://rsms.me/inter/font-files/Inter-Medium.woff2?v=3.11") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-Medium.woff?v=3.11") format("woff");
  }
  @font-face {
    font-family: Inter;
    font-style:  normal;
    font-weight: 600;
    src: url("https://rsms.me/inter/font-files/Inter-SemiBold.woff2?v=3.11") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-SemiBold.woff?v=3.11") format("woff");
  }
  @font-face {
    font-family: Inter;
    font-style:  normal;
    font-weight: 700;
    src: url("https://rsms.me/inter/font-files/Inter-Bold.woff2?v=3.11") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-Bold.woff?v=3.11") format("woff");
  }
  /* Modular scale with exponent 1.7^(1/3). The 1.7 was chosen as the line hight
     that goes well with Inter. Previously I used 1.59, but it was just too tight.
     0.59em
     0.70em
     1.00em
     1.19em
     1.42em
     1.70em
     2.02em
     2.42em
  */
  * { margin: 0; padding: 0; border-spacing: 0; }
  html {
    font-family: Inter, Roboto, sans-serif;
    /*
    Turn on character variant 8 for Inter, which puts serifs on the uppercase I.
    Also turn on variant 1, which has a curved 1.
    Disable contextual alternates for now. There is a bug, either in Inter or
    in Chrome (https://crbug.com/1046095) that causes colons after a <strong> to
    be raised above the baseline.
    */
    font-feature-settings: 'cv01' 1, 'cv08' 1, 'calt' 0;

    font-size: 16px;
    line-height: 1.7em;
    background-color: #fff;
    height: 100%;
  }
  body {
    height: 100%;
  }
  #content {
    display: grid;
    grid-template-columns: auto 16rem 50rem auto;
    color: #333;
    min-height: 100%;
  }
  #main {
    grid-area: 1 / 3 / 2 / 4;
    padding: 2.2rem;
    padding-left: 4rem;
    padding-right: 4rem;
    overflow: hidden;
  }
  #breadcrumbs {
    margin-bottom: 3rem;
    word-spacing: 0.3em;
    color: #78a;
  }
  #breadcrumbs a {
    word-spacing: 0;
    color: #78a;
  }
  article {
    margin-top: 1.3rem;
  }
  h1, h2, h3 {
    font-weight: 600;
    font-size: 1rem;
    color: #444;
    position: relative;
  }
  h1 {
    font-size: 2rem;
    margin-bottom: 2.1rem;
    line-height: 2.42rem;
    margin-top: -0.35rem;
    margin-bottom: 1.75rem;
  }
  h2 {
    font-size: 1.42rem;
    margin-top: 3.5rem;
    margin-bottom: 1.6rem;
  }
  .headerlink {
    position: absolute;
    left: -0.9em;
    width: 1em;
    opacity: 0.0;
    transition: opacity 0.2s ease-in;
  }
  /* Don't show the link for h1, usually you only have a single h1 at the top
     of the page, so it doesn't make much sense to add an anchor there, and with
     the larger font size, it doesn't fit in a narrow viewport. */
  h2:hover .headerlink, h3:hover .headerlink {
    opacity: 1.0;
  }
  code {
    font-family: 'Roboto Mono', monospace;
    font-size: 0.84rem;
    line-height: 1.5rem;
  }
  h3 > code {
    /* Roboto Mono 500 is about as heavy as Inter semibold (600). */
    font-weight: 500;
  }
  abbr {
    text-transform: uppercase;
    /* Downsize so caps are x-height, and compensate weight loss. */
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.05rem;
    /* Prevent abbrs from changing the line height of lines in which they occur. */
    line-height: 0;
  }
  sub, sup {
    /* Don't disturb the line height of normal text. */
    line-height: 0rem;
    font-size: 0.78rem;
    font-weight: 500;
  }
  p > code,
  a > code,
  h3 > code,
  li > code,
  td > code,
  dt > code,
  dd > code {
    background-color: #f0f0f0;
    padding: 0.13rem;
    padding-left: 0.3rem;
    padding-right: 0.3rem;
    border-radius: 0.2rem;
    line-height: 1rem;
  }
  h3 {
    padding-top: 0.9rem;
    padding-bottom: 0.8rem;
  }
  h3 > code {
    margin-left: -0.1rem;
  }
  a {
    color: #36d;
    text-decoration: none;
  }
  p, ul, ol, dl, pre, table {
    /* Same space as line height, leave exactly one line blank. */
    margin-bottom: 1.7rem;
  }
  pre {
    padding-top: 0.8rem;
    padding-bottom: 0.9rem;
    padding-left: 1.19rem;
    padding-right: 0;
    background-color: #f8f8f8;
    border-radius: 0 0.2rem 0.2rem 0;
    border-left: 0.3rem solid #d5d8e0;
    overflow-x: auto;
  }
  pre > code {
    margin-right: 1.41rem;
    color: #555;
  }
  code .k { color: #36d; }
  code .kt, code .nb { color: #d36; }
  code .c1, code .cm { color: #d36; font-style: italic; }
  code .s { color: #c43; }
  ul, ol {
    list-style-type: none;
    counter-reset: item;
  }
  table {
    font-variant-numeric: tabular-nums;
  }
  th, td {
    padding-right: 2rem;
  }
  th {
    text-align: left;
  }
  td > img {
    display: block;
    padding-top: 1em;
    padding-bottom: 1em;
  }
  dl {
    display: grid;
    grid-template-columns: 1fr 4fr;
    grid-column-gap: 2em;
  }
  dl dt {
    text-align: right;
  }
  #main ul li:before {
    color: #555;
    content: '\2022';
    display: inline-block;
    font-weight: 700;
    margin-left: -0.9rem;
    width: 0.9rem;
  }
  #main ul li {
    margin-left: 0.87rem;
  }
  #main ol li:before {
    content: counter(item);
    display: inline-block;
    font-weight: 700;
    width: 0.8rem;
    margin-left: -1.6rem;
    padding-right: 0.8rem;
  }
  #main ol li {
    margin-left: 1.6rem;
    counter-increment: item;
  }
  #nav-prev-next {
    margin-top: 3.4rem;
    padding-bottom: 3.3rem;
  }
  #nav-prev, #nav-next, #repo-link {
    display: inline-block;
  }
  #nav-prev {
    float: left;
  }
  #nav-next, #repo-link {
    float: right;
    text-align: right;
  }
  #nav-prev::before {
    content: '\219e';
    padding-right: 0.5em;
  }
  #nav-next::after {
    content: '\21a0';
    padding-left: 0.5em;
  }
  aside {
    grid-area: 1 / 1 / 2 / 3;
    border-right: 1px solid #eee;
    background-color: #fafafa;
    color: #78a;
  }
  aside nav {
    margin-top: 9rem;
    padding-bottom: 3.4rem;
    width: 14rem;
    float: right;
    /* Put the active chapter border over the sidebar border. */
    margin-right: -1px;
  }
  aside a {
    color: inherit;
  }
  aside .toc-section {
    font-weight: 700;
  }
  aside ul {
    margin-bottom: 0;
  }
  aside li {
    overflow: hidden;
    text-overflow: ellipsis;
  }
  aside li ul {
    padding-top: 0.6rem;
    padding-bottom: 1.1rem;
  }
  aside li.toc-section {
    margin-top: 1.7rem;
  }
  aside li.toc-section {
    color: #36d;
  }
  aside li.current, aside li ul {
    border-right: 0.3em solid #d5d8e0;
    padding-left: 1em;
    margin-left: -1em;
  }
  aside li.toc-chapter.current {
    font-weight: 600;
  }
  aside li.toc-heading {
    padding-left: 1em;
    padding-right: 0.3em;
  }

  @media(max-width: 63rem)
  {
    #content {
      /* Manual implementation of max-width: on narrower viewports,
         auto-size the body. */
      grid-template-columns: 0 16rem auto 0;
    }
  }

  @media(max-width: 1150px)
  {
    html { font-size: 15px; }
  }

  /* Move the sidebar TOC below content at small widths. */
  @media(max-width: 800px)
  {
    #content {
      display: block;
    }
    aside {
      border-top: 1px solid #eee;
      border-right: 0px none;
      padding-top: 1.7em;
    }
    aside nav {
      margin-left: 4em;
      margin-top: 1.7em;
      margin-right: 0;
      float: none;
      width: auto;
    }
    #main {
      padding-bottom: 1.7em;
    }
    /* Now that the TOC is full-width, adding the border on the right to
       highlight the active page is not as clear anymore, it can be far away.
       The current chapter is still in boldface, but that does not work for
       section indexes. So point a guillemet at it as well. */
    aside li.current, aside li ul {
      border-right: 0px none;
      position: relative;
    }
    aside li.current:before {
      content: '\203a';
      position: absolute;
      left: 0;
    }
  }

  /* Use less generous margins for very narrow viewports. */
  @media(max-width: 650px)
  {
    #main {
      padding-left: 2rem;
      padding-right: 2rem;
    }
    aside nav {
      margin-left: 2rem;
      padding-bottom: 2rem;
    }
  }

  @media(max-width: 450px)
  {
    #main {
      padding-left: 1.7em;
      padding-right: 1.7em;
    }
    aside nav {
      margin-left: 1.7em;
    }
  }
  </style>
</head>
<body>
  <div id="content">
    <div id="main">
      <nav id="breadcrumbs">
        <a href="https://ruuda.github.io/musium/">Musium</a>
         › <a href="../building/">User Guide</a> 
         › <a href="./">Disks</a> 
        <a id="repo-link" href="https://github.com/ruuda/musium/">GitHub</a>
      </nav>
      <article>
        <h1 id="disks">Disks<a class="headerlink" href="#disks">&para;</a></h1>
<p>Musium is built to handle music libraries in the order of terabytes in size.
Spinning disks are still the most cost-effective storage medium at this scale,
but storing your music on a spinning disk has downsides:</p>
<ul>
<li>Disks are slow, with high latency for reads, e.g. when starting a track.</li>
<li>Disks are noisy, you can hear them spin up, or hear them rattle when seeking.</li>
</ul>
<p>Especially for a music player, these can be a nuisance.</p>
<p>Furthermore, disks can spin down to save power when unused. While this does
reduce audible noise, it also causes access latencies of dozens of seconds when
accessing the disk after a period of inactivity.</p>
<h2 id="playback-disk-optimizations">Playback disk optimizations<a class="headerlink" href="#playback-disk-optimizations">&para;</a></h2>
<p>To optimize for disks that aggressively try to spin down, Musium takes the
following actions:</p>
<ul>
<li>Load all resources required to serve the webinterface into memory (aside from
   full-resolution cover art), to enable browsing the library without disk
   access.</li>
<li>Decode in bursts, and buffer about 10 minutes of audio in memory. When the
   play queue is full, this means that the disk only has to spin up about once
   every 10 minutes, and it can be silent in the meantime. The cost for 10
   minutes of 16-bit, 44.1 kHz stereo audio is about 105 MB of memory, which is
   still acceptable even on a Raspberry Pi.</li>
<li>Resume decoding well in time to allow for the disk to spin up before the
   buffer runs out.</li>
</ul>
<h2 id="indexing-disk-optimizations">Indexing disk optimizations<a class="headerlink" href="#indexing-disk-optimizations">&para;</a></h2>
<p>Indexing is typically <abbr>IO</abbr>-bound when the music library is not in the
page cache. (And the only reason why it would be in the page cache, is because
you indexed the library a moment ago.) Musium optimizes for this by indexing
using many threads, to cause many parallel reads. This disk access pattern gives
the operating system many <abbr>IO</abbr> operations to work with when
minimizing seek distance.</p>
<p>To make this optimization more effective, the <abbr>IO</abbr> queue of your
disk should be sufficiently large. Set the size using e.g.</p>
<pre><code>echo 2048 | sudo tee /sys/block/sda/queue/nr_requests
</code></pre>
<p>A queue size of 2 versus 2048 can make a factor 2 difference in indexing time!</p>
<h2 id="the-play-database">The play database<a class="headerlink" href="#the-play-database">&para;</a></h2>
<p>Musium keeps a record of which songs you played in a database. It writes to this
database every time a new track starts playing. When you keep this database on
a spinning disk, that undermines the above optimizations. Fortunately, the
database should not be terabytes in size, so it can easily be kept on
solid-state storage, for example on the <abbr>SD</abbr> card of a Raspberry Pi.</p>
      </article>
      <nav id="nav-prev-next">
        <a id="nav-prev" href="../tradfri/" title="Trådfri control">Previous</a>
        <a id="nav-next" href="../api/" title="API Reference">Next</a>
        </nav>
      </div>
    <aside>
      <nav>
        <ul>
        <li class="toc-section"><a href="..">Overview</a></li>
          <li class="toc-section
            "><a href="../building/">User Guide</a></li>
          
            <li class="toc-chapter
              "><a href="../building/">Building</a></li>
            
            <li class="toc-chapter
              "><a href="../configuration/">Configuration</a></li>
            
            <li class="toc-chapter
              "><a href="../running/">Running</a></li>
            
            <li class="toc-chapter
              "><a href="../webinterface/">Webinterface</a></li>
            
            <li class="toc-chapter
              "><a href="../tagging/">Tagging</a></li>
            
            <li class="toc-chapter
              "><a href="../loudness/">Loudness normalization</a></li>
            
            <li class="toc-chapter
              "><a href="../scrobbling/">Scrobbling to Last.fm</a></li>
            
            <li class="toc-chapter
              "><a href="../listenbrainz/">Submitting to Listenbrainz</a></li>
            
            <li class="toc-chapter
              "><a href="../tradfri/">Trådfri control</a></li>
            
            <li class="toc-chapter
               current"><a href="./">Disks</a></li>
            <li><ul>
                <li class="toc-heading"><a href="#playback-disk-optimizations">Playback disk optimizations</a></li>
                <li class="toc-heading"><a href="#indexing-disk-optimizations">Indexing disk optimizations</a></li>
                <li class="toc-heading"><a href="#the-play-database">The play database</a></li>
                </ul></li>
               <li class="toc-section"><a href="../api/">API Reference</a></li>
          <li class="toc-section
            "><a href="../search/">Internals</a></li>
          
            <li class="toc-chapter
              "><a href="../search/">Search</a></li>
            
            <li class="toc-chapter
              "><a href="../performance/">Performance</a></li>
            
            <li class="toc-chapter
              "><a href="../thumbnails/">Thumbnails</a></li>
            </ul>
      </nav>
    </aside>
  </div>
</body>
</html>